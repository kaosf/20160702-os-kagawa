<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="ka (kaosfield)" />
  <meta name="date" content="2016-07-02" />
  <title>tokushima.rbの紹介とItamaeを使ってみた話</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
  </style>
  <link rel="stylesheet" type="text/css" media="screen, projection, print"
    href="https://www.w3.org/Talks/Tools/Slidy2/styles/slidy.css" />
  <script src="https://www.w3.org/Talks/Tools/Slidy2/scripts/slidy.js"
    charset="utf-8" type="text/javascript"></script>
</head>
<body>
<div class="slide titlepage">
  <h1 class="title">tokushima.rbの紹介とItamaeを使ってみた話</h1>
  <p class="author">
ka (<a href="http://www.kaosfield.net">kaosfield</a>)
  </p>
  <p class="date">2016-07-02</p>
</div>
<div id="はじめに" class="slide section level1">
<h1>はじめに</h1>
<p>このスライドは公開されています</p>
<p><a href="https://kaosf.github.io/20160702-os-kagawa" class="uri">https://kaosf.github.io/20160702-os-kagawa</a></p>
<p>Repository: <a href="https://github.com/kaosf/20160702-os-kagawa">kaosf/20160702-os-kagawa - GitHub</a></p>
<p>もう一度見たい内容がある場合は後から参照できます</p>
<p>ゆったりした気持ちで聞いてください</p>
</div>
<div id="tokushima.rbとは" class="slide section level1">
<h1>tokushima.rbとは</h1>
<p>地域.rbの徳島版です</p>
<p>毎月最終日曜日にねすとラボという場所で開催しています</p>
<p>申し込みも特に必要ではありません</p>
<p>途中参加・途中休憩・途中退場も完全自由なのでお気軽にお越しください</p>
</div>
<div id="tokushima.rbとは-1" class="slide section level1">
<h1>tokushima.rbとは</h1>
<p>Facebookページ <a href="https://www.facebook.com/groups/tokushima.rb/" class="uri">https://www.facebook.com/groups/tokushima.rb/</a></p>
<p>Conpass <a href="http://tokushimarb.connpass.com/" class="uri">http://tokushimarb.connpass.com/</a></p>
<p>今までの発表やハンズオンの資料は全て公開しています</p>
<p>tokushima.rb - github.io <a href="http://tokushimarb.github.io/" class="uri">http://tokushimarb.github.io/</a></p>
</div>
<div id="なにをしているの" class="slide section level1">
<h1>なにをしているの？</h1>
<p>主にもくもく会です</p>
<p>ときどき発表もあります</p>
</div>
<div id="今までの発表" class="slide section level1">
<h1>今までの発表</h1>
<p>※スライドがあったものだけの紹介になります</p>
<ul>
<li>
<a href="https://sunny4381.github.io/remark.js/index.html?/slides/2015-03-29/rspec-extension.md">RSpec の便利機能と SHIRASAGI に Database Cleaner を導入した話</a>
</li>
<li>
<a href="http://kaosf.github.io/20140831-tokushimarb-slide">Ruby入門</a> by <a href="http://www.kaosfield.net">ka</a>
</li>
<li>
<a href="http://kaosf.github.io/20140928-tokushimarb-slide">Ruby超入門</a> by <a href="http://www.kaosfield.net">ka</a>
</li>
<li>
<a href="http://kaosf.github.io/20141026-tokushimarb-slide">method_missing</a> by <a href="http://www.kaosfield.net">ka</a>
</li>
<li>
<a href="https://www.slideshare.net/secret/d0MkzQdiT8cQIK">Rubyを使ったスマホアプリのUIテスト</a> by <a href="https://www.facebook.com/kenichi.tatsuhama">辰濱</a>
</li>
<li>
<a href="http://kaosf.github.io/20150830-tokushimarb-slide">ElixirとPhoenixの紹介</a> by <a href="http://www.kaosfield.net">ka</a>
</li>
<li>
<a href="http://www.slideshare.net/dany1468/cer-turbolinks-3">C#er から見た Turbolinks 3</a> by <a href="https://twitter.com/dany1468">dany1468</a>
</li>
</ul>
</div>
<div id="発表お待ちしてます" class="slide section level1">
<h1>発表お待ちしてます</h1>
<p>というか面白いRubyネタの発表お待ちしております</p>
<p>「○○使ってみた」とかレベルでも大歓迎</p>
<p>何か罠にハマった経験談はありがたがられます</p>
<p>今個人的に聞きたいのはC拡張の話や Ruby 3.0 の話</p>
</div>
<div id="こんな人は是非お越し下さい" class="slide section level1">
<h1>こんな人は是非お越し下さい</h1>
<p>Ruby入門したい人</p>
<p>Rails使ってみたけど○○がよく分からない…</p>
<p>gemを作ってみたいんだけどどうすればいいの？</p>
</div>
<div id="次回は7月31日" class="slide section level1">
<h1>次回は7月31日</h1>
<p>Facebook <a href="https://www.facebook.com/events/610716995754420/" class="uri">https://www.facebook.com/events/610716995754420/</a></p>
<p>Connpass <a href="http://tokushimarb.connpass.com/event/35019/" class="uri">http://tokushimarb.connpass.com/event/35019/</a></p>
<p>遠路はるばるになる方が多いと思いますがもし余裕があって来ていただければ大歓迎です</p>
</div>
<div id="itamaeの話" class="slide section level1">
<h1>Itamaeの話</h1>
<p>(主に)サーバのprovisioningをするツール</p>
<p>もうちょっと砕いて言うとサーバにパッケージをインストールしたり設定ファイルを書き換えたりしてくれるツール</p>
<p>2015年にはもっと流行ってました</p>
<p>今はもう皆普通に使ってる感じです</p>
</div>
<div id="使ってみた感想的な話" class="slide section level1">
<h1>使ってみた感想的な話</h1>
<p>入門記事や解説記事が大体2015年の投稿でかなり大量に出回っているので調べて実践してみるにあたってはとても楽でした</p>
<p>大体4日くらいチマチマと練習して昨日本番環境を実際に作ってみました</p>
<p>ベストプラクティス的なものを模索しながら書いてたので何度も何度も書き直しました</p>
<p>今までシェルスクリプトをゴリゴリ書いていたのに比べると良くなったところの方がやっぱり多いです</p>
<p>紹介出来るだけ紹介していきます</p>
</div>
<div id="使い始める" class="slide section level1">
<h1>使い始める</h1>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="kw">gem</span> install itamae

<span class="kw">cat</span> &lt;&lt;EOF &gt; recipe.rb
package &#39;nginx&#39;
service &#39;nginx&#39; do
  action [:enable, :start]
end
EOF

ita<span class="kw">mae</span> ssh --host 123.456.78.90 recipe.rb</code></pre></div>
<p>これだけでNginxパッケージが動くマシンになりました</p>
</div>
<div id="環境を選ばない" class="slide section level1">
<h1>環境を選ばない</h1>
<p>びっくりしたことにArch Linuxのサーバにこの設定でNginxがインストールされました</p>
<p>Itamaeが <a href="https://github.com/mizzy/specinfra">specinfra</a> というgemを使ってこの辺の面倒は見てもらっているようです</p>
<p>以下 <code>itamae.gemspec</code> より抜粋</p>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">  spec.add_runtime_dependency <span class="st">&quot;specinfra&quot;</span>, [<span class="st">&quot;&gt;= 2.37.0&quot;</span>, <span class="st">&quot;&lt; 3.0.0&quot;</span>]</code></pre></div>
</div>
<div id="前提" class="slide section level1">
<h1>前提</h1>
<p>当然動く前提はあります</p>
<ul>
<li>
マシンにSSHログイン可能である
</li>
<li>
sudo出来る
</li>
</ul>
</div>
<div id="前提-1" class="slide section level1">
<h1>前提</h1>
<p>Vagrantを使って練習するときはsudoがパスワード無しで実行出来ます</p>
<p>本番環境で実際にやる際にはsudoのためのパスワードを聞いてくれます</p>
<p>面倒くさければ</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="kw">sudo</span> visudo</code></pre></div>
<p>で <code>/etc/sudoers</code> の編集を開始して末尾に</p>
<pre><code>yourname ALL=(ALL) NOPASSWD: ALL</code></pre>
<p>という一行を追加して一時的にsudoがパスワード無しでも実行出来るように変更しておけばいいんじゃないでしょうか</p>
<p>SSHのパスワードログインを禁止にするなどして気をつけてからやりましょう</p>
</div>
<div id="rootユーザでログイン出来るなら" class="slide section level1">
<h1>rootユーザでログイン出来るなら</h1>
<p>多分褒められた状態では無いと思いますが</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="kw">itamae</span> ssh --host 123.456.78.90 recipe.rb -u root</code></pre></div>
<p><code>-u</code> でユーザを指定出来ます</p>
</div>
<div id="今日話すこと" class="slide section level1">
<h1>今日話すこと</h1>
<p>今更改めて「Itamaeとは何か」「何が特徴か」を解説したりはしません</p>
<p>スライドの後の方で私が実際にこの一週間ほどで何度も何度も参照した記事を紹介しています</p>
<p>それらに目を通して自分で手を動かすのが一番理解というゴールに近い道でしょう</p>
<p>なので私が「使ってみてしんどかったこと」「ハマった罠」「『便利だ…』と感動したこと」などをほぼノンジャンルでまくしたてる形にしたいと思います</p>
</div>
<div id="rubyのインストール" class="slide section level1">
<h1>Rubyのインストール</h1>
<p>rbenvを使ってインストールします</p>
<p><a href="https://github.com/k0kubun/itamae-plugin-recipe-rbenv">k0kubun/itamae-plugin-recipe-rbenv: Itamae plugin to install ruby with rbenv</a></p>
<p>Bashの人は<code>.bash_profile</code>に<br />
Zshの人は<code>.zshenv</code>に</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="kw">export</span> <span class="ot">RBENV_ROOT=</span>/usr/local/rbenv
<span class="kw">export</span> <span class="ot">PATH=</span><span class="st">&quot;</span><span class="ot">${RBENV_ROOT}</span><span class="st">/bin:</span><span class="ot">$PATH</span><span class="st">&quot;</span>
<span class="kw">eval</span> <span class="st">&quot;</span><span class="ot">$(</span><span class="kw">rbenv</span> init -<span class="ot">)</span><span class="st">&quot;</span></code></pre></div>
<p>を付け加えなければなりません</p>
</div>
<div id="レシピ" class="slide section level1">
<h1>レシピ</h1>
<p><code>recipe.rb</code>として以下のファイルを用意</p>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">include_recipe <span class="st">&#39;rbenv::system&#39;</span>

user node[<span class="st">:server</span>][<span class="st">:user</span>]

execute <span class="st">&quot;add rbenv path&quot;</span> <span class="kw">do</span>
  command &lt;&lt;-<span class="kw">EOH</span>
<span class="ot">cat &lt;&lt;EOS &gt;&gt; /home/#{</span>node[<span class="st">:server</span>][<span class="st">:user</span>]<span class="ot">}/.bash_profile</span>
<span class="ot">export RBENV_ROOT=/usr/local/rbenv</span>
<span class="ot">export PATH=&quot;\\${RBENV_ROOT}/bin:\\$PATH&quot;</span>
<span class="ot">eval &quot;\\$(rbenv init -)&quot;</span>
<span class="ot">EOS</span>
<span class="kw">EOH</span>

  not_if <span class="st">&quot;grep -q rbenv /home/</span><span class="ot">#{</span>node[<span class="st">:server</span>][<span class="st">:user</span>]<span class="ot">}</span><span class="st">/.bash_profile&quot;</span>
<span class="kw">end</span></code></pre></div>
</div>
<div id="マシンごとの個別設定的なもの" class="slide section level1">
<h1>マシンごとの個別設定的なもの</h1>
<p><code>node.yml</code> として以下のようなファイルを用意</p>
<div class="sourceCode"><pre class="sourceCode yml"><code class="sourceCode yaml"><span class="fu">server:</span>
  <span class="fu">user:</span> myname

<span class="fu">rbenv:</span>
  <span class="fu">global:</span> 2.3.1
  <span class="fu">versions:</span>
    <span class="kw">-</span> 2.3.1
  <span class="fu">scheme:</span> https
  <span class="fu">cache:</span> true
<span class="fu">ruby-build:</span>
  <span class="fu">revision:</span> c593baacd271f8807cb6ecd16b0bcb70491327a8
<span class="fu">rbenv-default-gems:</span>
  <span class="fu">default-gems:</span>
    <span class="kw">-</span> bundler 1.12.5
  <span class="fu">install:</span> true</code></pre></div>
</div>
<div id="実行コマンド" class="slide section level1">
<h1>実行コマンド</h1>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="kw">itamae</span> ssh --host 123.456.78.90 recipe.rb -y node.yml</code></pre></div>
<p>これでOK</p>
</div>
<div id="これが面倒くさい" class="slide section level1">
<h1>これが面倒くさい</h1>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">execute <span class="st">&quot;add rbenv path&quot;</span> <span class="kw">do</span>
  command &lt;&lt;-<span class="kw">EOH</span>
<span class="ot">cat &lt;&lt;EOS &gt;&gt; /home/#{</span>node[<span class="st">:server</span>][<span class="st">:user</span>]<span class="ot">}/.bash_profile</span>
<span class="ot">export RBENV_ROOT=/usr/local/rbenv</span>
<span class="ot">export PATH=&quot;\\${RBENV_ROOT}/bin:\\$PATH&quot;</span>
<span class="ot">eval &quot;\\$(rbenv init -)&quot;</span>
<span class="ot">EOS</span>
<span class="kw">EOH</span></code></pre></div>
<p>ナニコレって感じですよね</p>
<p>もう二度と考えたくないです</p>
<p>今後はずっと使いまわします</p>
</div>
<div id="section" class="slide section level1">
<h1></h1>
<p>ちなみにヒアドキュメントにせず</p>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">  command <span class="st">&quot;echo \&quot;foooooo\&quot; &gt;&gt; /home/</span><span class="ot">#{</span>node[<span class="st">:server</span>][<span class="st">:user</span>]<span class="ot">}</span><span class="st">/.bash_profile; ... &quot;</span></code></pre></div>
<p>としても面倒くささはあまり解消されません</p>
</div>
<div id="自作レシピgem" class="slide section level1">
<h1>自作レシピgem？</h1>
<p>もしかしたらこういうのをgemにしてレシピ公開するといいのかも…？</p>
</div>
<div id="node.yml-for-rbenv例" class="slide section level1">
<h1>node.yml for rbenv例</h1>
<div class="sourceCode"><pre class="sourceCode yml"><code class="sourceCode yaml"><span class="fu">server:</span>
  <span class="fu">user:</span> myname

<span class="fu">rbenv:</span>
  <span class="fu">global:</span> 2.3.1
  <span class="fu">versions:</span>
    <span class="kw">-</span> 2.3.1
  <span class="fu">scheme:</span> https
  <span class="fu">cache:</span> true
<span class="fu">ruby-build:</span>
  <span class="fu">revision:</span> c593baacd271f8807cb6ecd16b0bcb70491327a8
<span class="fu">rbenv-default-gems:</span>
  <span class="fu">default-gems:</span>
    <span class="kw">-</span> bundler 1.12.5
  <span class="fu">install:</span> true</code></pre></div>
<p>詳しくはitamae-plugin-recipe-rbenvのREADMEを読むこと</p>
</div>
<div id="node.yml-for-rbenv例-1" class="slide section level1">
<h1>node.yml for rbenv例</h1>
<p>レシピ内で</p>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">node[<span class="st">:server</span>][<span class="st">:user</span>]</code></pre></div>
<p>などと参照していた情報の出所はこのファイルの内容になります</p>
<p>さっきの例ですと <code>&quot;myname&quot;</code></p>
</div>
<div id="packageをインストール" class="slide section level1">
<h1>packageをインストール</h1>
<p><code>yum</code> ないし <code>apt</code> (※今はもう <code>apt-get</code> は古い) ないし <code>brew</code> ないし <code>yaourt</code> などでインストールするアレ</p>
</div>
<div id="package" class="slide section level1">
<h1>package</h1>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">package <span class="st">&#39;nginx&#39;</span></code></pre></div>
<p>最初にも例を出した通りこんな感じでパッケージのインストールが出来ます</p>
</div>
<div id="yumのgroupinstallは" class="slide section level1">
<h1>yumのgroupinstallは？</h1>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">package <span class="st">&#39;Development Tools&#39;</span></code></pre></div>
<p>これではダメでした</p>
<p>特にこれといって</p>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">package <span class="st">&#39;Development Tools&#39;</span>
  awesome_option <span class="st">&#39;for groupinstall&#39;</span>
<span class="kw">end</span></code></pre></div>
<p>みたいなことも出来ず</p>
</div>
<div id="どうしたか" class="slide section level1">
<h1>どうしたか</h1>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">execute <span class="st">&#39;sudo yum -y groupinstall &quot;Development Tools&quot;&#39;</span></code></pre></div>
<p><code>execute</code> で任意のコマンドが実行できるのでそれでやれば良い</p>
<p>OS依存？そもそも <code>Development Tools</code> というパッケージを<br />
インストールしようとすること自体がOS依存なのだ！と割り切る</p>
<p>参考: <a href="https://github.com/hsbt/itamae-lesson/blob/master/recipe.rb">itamae-lesson/recipe.rb at master · hsbt/itamae-lesson</a></p>
</div>
<div id="git" class="slide section level1">
<h1>git</h1>
<p>アプリケーションサーバ用のリポジトリをBitbucketのprivate repositoryから取ってこようとしました</p>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">git <span class="st">&quot;/home/user/app&quot;</span> <span class="kw">do</span>
  repository <span class="st">&quot;git@bitbucket.org:kaosf/myapp.git&quot;</span>
<span class="kw">end</span></code></pre></div>
<p>初めてだったのでSSH認証完全に通ってて手動で<code>git clone</code>が問題なく出来る状態にしてから試したのですが…</p>
</div>
<div id="gitが動かない" class="slide section level1">
<h1>gitが動かない</h1>
<p>何故か止まってしまう</p>
<p>cloneされるディレクトリを見てみると</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="kw">ls</span> -l ~</code></pre></div>
<pre><code># (前略)
drwxr-xr-x 3 root root 17 Jul  1 00:00 app
# (後略)</code></pre>
<p>所有者がrootに！？</p>
</div>
<div id="execute" class="slide section level1">
<h1>execute？</h1>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">execute <span class="st">&quot;git clone git@bitbucket.org:kaosf/myapp.git /home/user/myapp&quot;</span></code></pre></div>
<p>先ほどのgroupinstallみたいに上手くいくか？</p>
<p>と思ったのですがダメでした…</p>
<p>もちろん <code>-u</code> オプションの指定を間違えているというようなこともなく…</p>
</div>
<div id="gitだけは諦めた" class="slide section level1">
<h1>gitだけは諦めた</h1>
<p>手動でcloneしてその後のライブラリインストールなどの処理は手動でやるように<br />
結局シェルスクリプト組んだ…</p>
<p>何か知ってる人居たら教えて下さい</p>
</div>
<div id="gitが動く例" class="slide section level1">
<h1>gitが動く例</h1>
<p>公開リポジトリからSSH認証とか無しで取ってくるのは普通に出来ます</p>
<p>自分のプロジェクトが依存するOSSのソースコードを取ってきて野良ビルドするときなどは有用なはずです</p>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">git <span class="st">&#39;/home/user/conoha&#39;</span> <span class="kw">do</span>
  repository <span class="st">&#39;git://github.com/kaosf/conoha.git&#39;</span>
<span class="kw">end</span></code></pre></div>
</div>
<div id="itamae-plugin-recipe-rbenvの問題" class="slide section level1">
<h1>itamae-plugin-recipe-rbenvの問題</h1>
<p>システムワイドにRubyをrbenvでインストールするのは簡単でした</p>
<p>ユーザローカルにインストールしようとしたときに問題が発生しました</p>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">include_recipe <span class="st">&#39;rbenv::user&#39;</span></code></pre></div>
<p>↑こういう感じに(READMEにある通り)</p>
<p><code>default-gems</code> というファイルの所有者が <code>root</code> になっていてエラーを吐きます</p>
<p>正直Bundlerは無いと生きていけないのでdefault-gemsの設定は必須と言えます</p>
</div>
<div id="関連するissueとpull-request" class="slide section level1">
<h1>関連するIssueとPull Request</h1>
<ul>
<li>
<a href="https://github.com/k0kubun/itamae-plugin-recipe-rbenv/pull/13">fix owner for a user by iyuuya · Pull Request #13 · k0kubun/itamae-plugin-recipe-rbenv</a>
</li>
<li>
<a href="https://github.com/k0kubun/itamae-plugin-recipe-rbenv/issues/14">default-gemsファイルの生成に失敗する · Issue #14 · k0kubun/itamae-plugin-recipe-rbenv</a>
</li>
</ul>
</div>
<div id="forkを使う" class="slide section level1">
<h1>forkを使う</h1>
<p>本家のgemの方がエラーを吐く状態ですが修正案が一応見つかりました</p>
<p>慌てずGemfileを用いて</p>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">gem <span class="st">&#39;itamae&#39;</span>
gem <span class="st">&#39;itamae-plugin-recipe-rbenv&#39;</span>,
  <span class="st">git: &#39;git://github.com/iyuuya/itamae-plugin-recipe-rbenv&#39;</span>,
  <span class="st">branch: &#39;fix-default-gem&#39;</span></code></pre></div>
</div>
<div id="forkを使う-1" class="slide section level1">
<h1>forkを使う</h1>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="kw">bundle</span> install</code></pre></div>
<p>もしくは</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="kw">bundle</span> install --path vendor/bundle</code></pre></div>
<p>して</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="kw">bundle</span> exec itamae ...</code></pre></div>
<p>として使っていきます</p>
</div>
<div id="私の環境のgemfileの差分" class="slide section level1">
<h1>私の環境のGemfileの差分</h1>
<p><code>Gemfile</code></p>
<div class="sourceCode"><pre class="sourceCode diff"><code class="sourceCode diff"><span class="st">- gem &#39;itamae-plugin-recipe-rbenv&#39;, &#39;0.6.2&#39;</span>
<span class="ot">+ gem &#39;itamae-plugin-recipe-rbenv&#39;,</span>
<span class="ot">+   git: &#39;git://github.com/iyuuya/itamae-plugin-recipe-rbenv&#39;,</span>
<span class="ot">+   branch: &#39;fix-default-gem&#39;</span></code></pre></div>
</div>
<div id="システムワイドでいいじゃん" class="slide section level1">
<h1>システムワイドでいいじゃん</h1>
<p>しかしこういうしょうもないことをItamaeを使っているせいで考えるのは正直しんどいです</p>
<p>なのでここは割り切って</p>
<ol>
<li>
rbenvはもうシステムワイド一択
</li>
<li>
Bundlerを必ず使って
</li>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="kw">bundle</span> install --path vendor/bundle<span class="kw">`</span>
<span class="kw">bundle</span> exec rake</code></pre></div>
</ol>
<p>するようにしましょう</p>
<p>私はそうしました</p>
</div>
<div id="node.js" class="slide section level1">
<h1>Node.js</h1>
<p><code>node.yml</code>の例</p>
<div class="sourceCode"><pre class="sourceCode yml"><code class="sourceCode yaml"><span class="fu">nodebrew:</span>
  <span class="fu">versions:</span>
    <span class="fu">v5.9.0:</span>
      <span class="kw">-</span> gulp
  <span class="fu">use:</span> v5.9.0</code></pre></div>
<p>さらに詳しくはitamae-plugin-recipe-nodebrewのREADMEを参照</p>
<p><a href="https://github.com/toihrk/itamae-plugin-recipe-nodebrew#nodejson" class="uri">https://github.com/toihrk/itamae-plugin-recipe-nodebrew#nodejson</a></p>
</div>
<div id="yamlで空の配列" class="slide section level1">
<h1>YAMLで空の配列</h1>
<p><a href="https://github.com/toihrk/itamae-plugin-recipe-nodebrew/blob/master/lib/itamae/plugin/recipe/nodebrew/system.rb#L20">itamae-plugin-recipe-nodebrew/system.rb at master · toihrk/itamae-plugin-recipe-nodebrew</a></p>
<p>ここに</p>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">(node[<span class="st">&#39;nodebrew&#39;</span>][<span class="st">&#39;versions&#39;</span>] || {}).each <span class="kw">do</span> |node_version, npms|
  node_install node_version <span class="kw">do</span>
    profile_path <span class="dt">NODEBREW_PROFILE_PATH</span>
  <span class="kw">end</span>
  npms.each <span class="kw">do</span> |npm|
    <span class="co"># ...</span>
  <span class="kw">end</span>
<span class="kw">end</span></code></pre></div>
<p>というコードがあります</p>
</div>
<div id="yamlで空の配列-1" class="slide section level1">
<h1>YAMLで空の配列</h1>
<p>なので一つもnpmでパッケージをインストールしたくない場合は先程のymlファイルで空の配列を設定する必要があります</p>
<p>もしもnullだとRubyで</p>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="dv">nil</span>.each <span class="kw">do</span> |npm|
<span class="kw">end</span></code></pre></div>
<p>を実行することになってしまいここでプログラムが落ちるためです</p>
</div>
<div id="yamlで空の配列-2" class="slide section level1">
<h1>YAMLで空の配列</h1>
<ul>
<li>
<a href="http://chyk.github.io/blog/2013/06/12/yaml-de,-kong-falsepei-lie/">YAML で、空の配列 - My Octopress Blog</a>
</li>
<li>
<a href="http://qiita.com/kiaidangoo/items/3b619bca5cf912f6c339">YAMLで空の配列を表現する - Qiita</a>
</li>
</ul>
<p>リンク先にも書いてますが</p>
<div class="sourceCode"><pre class="sourceCode yml"><code class="sourceCode yaml"><span class="fu">versions:</span>
  <span class="fu">v5.9.0:</span></code></pre></div>
<p>だけだと NULL になってしまうのです(これにハマった)</p>
</div>
<div id="yamlで空の配列-3" class="slide section level1">
<h1>YAMLで空の配列</h1>
<div class="sourceCode"><pre class="sourceCode yml"><code class="sourceCode yaml"><span class="fu">versions:</span>
  <span class="fu">v5.9.0:</span> <span class="kw">[]</span></code></pre></div>
<p>正解はこう</p>
</div>
<div id="templateとremote_file" class="slide section level1">
<h1>templateとremote_file</h1>
<p>設定ファイルを用意しておいたり雛形を用意しておいたり出来ます</p>
<p>remote_fileの方は作ってあるファイルをそのまま設置するだけですがtemplateの方はERBになっています</p>
<p>設定ファイル内にユーザ名を埋め込みたいが環境によって変わる…というような場合に</p>
<pre class="erb"><code>awesome_configuration:
  host: 192.168.10.1
  port: 12345
  user: &lt;%= node[:server][:user] %&gt;</code></pre>
<p>みたいなことが出来ます</p>
<p>レシピから変数を渡して <code>@var</code> と参照することも出来ます</p>
</div>
<div id="templateのお陰で救われたこと" class="slide section level1">
<h1>templateのお陰で救われたこと</h1>
<p>最初はtemplateを設置してしまうとデフォルトで用意されていた設定をもしかしたら図らずしも上書きによって消滅させてしまうかもしれない…という不安がありました</p>
<p>しかしItamaeは賢くてもしも既にファイルが存在した場合にはそいつとの差分を見せてくれます</p>
<div class="sourceCode"><pre class="sourceCode diff"><code class="sourceCode diff"><span class="st">- XXXX=1234</span>
<span class="ot">+ XXXX=2345</span>
  YYYY
<span class="st">- YYYY1</span>
<span class="st">- YYYY2</span>
<span class="ot">+ ZZZZ1</span>
<span class="ot">+ ZZZZ2</span></code></pre></div>
<p>こんな感じ(実際はマイナスが<span style="color:red">赤</span>，プラスが<span style="color:green">緑</span>になります)</p>
<p>なので妙に赤が多い…と思ったらよく調査してみればいいのです</p>
</div>
<div id="templateのお陰で救われたこと-1" class="slide section level1">
<h1>templateのお陰で救われたこと</h1>
<p>これでもう</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="kw">cat</span> /etc/foo.conf <span class="kw">|</span> <span class="kw">\</span>
  <span class="kw">sed</span> <span class="st">&#39;s/^#conf1=default/conf1=myname/&#39;</span> <span class="kw">|</span> <span class="kw">\</span>
  <span class="kw">sed</span> <span class="st">&#39;s/^conf2=enable/conf2=disable/&#39;</span> <span class="kw">|</span> <span class="kw">\</span>
  <span class="kw">&gt;</span> <span class="kw">/tmp/foo.conf</span>
\<span class="kw">mv</span> /etc/foo.conf /etc/foo.conf.orig
\<span class="kw">mv</span> /tmp/foo.conf /etc/foo.conf</code></pre></div>
<p>とかを大量に書かなくてもいい…</p>
</div>
<div id="参考リンク" class="slide section level1">
<h1>参考リンク</h1>
<p>あとで言うと言ってたやつです</p>
<ul>
<li>
<a href="http://qiita.com/fukuiretu/items/170aa956731f2ffb5715">Itamaeチートシート - Qiita</a>
</li>
<li>
<a href="http://llcc.hatenablog.com/entry/2015/07/05/160822">Itamae入門した ~ Vagrantのサーバーにnginx入れるまで - しめ鯖日記</a>
</li>
<li>
<a href="https://github.com/itamae-kitchen/itamae/wiki/Best-Practice">Best Practice · itamae-kitchen/itamae Wiki</a>
</li>
<li>
<a href="http://totutotu.hatenablog.com/entry/2015/10/30/Itamae%E3%83%AC%E3%82%B7%E3%83%94%E9%9B%86_-_Ruby/nginx/MySQL/Redis/etc">Itamaeレシピ集 - Ruby/nginx/MySQL/Redis/etc - 珈琲駆動開発</a>
</li>
</ul>
</div>
<div id="他に伝えたいこと要約-感想まとめ" class="slide section level1">
<h1>他に伝えたいこと要約 + 感想まとめ</h1>
<ul>
<li>
ベストプラクティスはちゃんと見てディレクトリ構成を整えよう
</li>
<li>
意外と欲しいレシピがありそうで無い
</li>
<li>
結局普通にコマンドで作業出来ないとダメ(サーバ構築未経験者が最初からitamaeは無理)
</li>
<li>
OSのことちゃんと分かってないとダメ
</li>
<li>
シェルスクリプトから逃れられると思うな(結局executeを駆使することが多い)
</li>
</ul>
</div>
<div id="systemd関連" class="slide section level1">
<h1>systemd関連</h1>
<ul>
<li>
<a href="http://enakai00.hatenablog.com/entry/20130917/1379374797">Systemd入門(4) - serviceタイプUnitの設定ファイル - めもめも</a>
</li>
<li>
<a href="http://qiita.com/DQNEO/items/0b5d0bc5d3cf407cb7ff">Systemdを使ってさくっと自作コマンドをサービス化してみる - Qiita</a>
</li>
<li>
<a href="http://qiita.com/gongo/items/ae26632416f864a732cf">Itamae で firewalld を操作する itamae-plugin-resource-firewalld - Qiita</a>
</li>
</ul>
<p>自分はこの辺がまだ正直言って自信が無いのでちゃんと <code>nantoka.service</code> を作って</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="kw">systemctl</span> start nantoka.service</code></pre></div>
<p>を正しく出来るようにしたいです</p>
</div>
<div id="自作conoha-gemの話" class="slide section level1">
<h1>自作conoha gemの話</h1>
<p>今回マシンを作ったり壊したりして実験していたのですが</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="kw">vagrant</span> up</code></pre></div>
<p>よりもConoHaのVPSを作って壊してする方が速いので自作のConoHa VPS CLI clientを使っていました</p>
<p>そろそろVersion 1.0.0にしたいのですがまだ内部の構造が汚すぎてそんな状態でメジャーバージョン1にしたくないのでまだ0.8.1という状態</p>
</div>
<div id="conoha-gem使い方簡単紹介" class="slide section level1">
<h1>conoha gem使い方簡単紹介</h1>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="kw">conoha</span> create centos72 g-1gb <span class="co"># CentOS 7.2 の RAM 1GB のマシン作成</span>
<span class="co"># UUID が表示される</span>

<span class="kw">conoha</span> ipaddress <span class="ot">$UUID</span>
<span class="co"># IPアドレスが表示される</span>

<span class="kw">ssh</span> root@<span class="ot">$IPADDRESS</span>

<span class="kw">conoha</span> rebuild <span class="ot">$UUID</span> ubuntu
<span class="co"># Ubuntu を再インストール</span>

<span class="kw">conoha</span> shutdown <span class="ot">$UUID</span>
<span class="co"># シャットダウン</span>

<span class="kw">conoha</span> delete <span class="ot">$UUID</span>
<span class="co"># マシン削除</span></code></pre></div>
</div>
<div id="conoha-gem使い方簡単紹介-1" class="slide section level1">
<h1>conoha gem使い方簡単紹介</h1>
<p>1台だけ「これ！」と決めて使うのであれば <code>conoharant</code> コマンド<br />
(※言わずもがなvagrantとconohaを合わせた造語)<br />
があります</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="kw">mkdir</span> a<span class="kw">;</span> <span class="kw">cd</span> a
<span class="kw">conoharant</span> init
<span class="kw">vi</span> Conoharantfile <span class="co"># 使いたいOSを選んだり設定を弄る(デフォルトはCentOS 7.2のメモリ1GB)</span>

<span class="kw">conoharant</span> up
<span class="kw">conoharant</span> ssh root
<span class="kw">conoharant</span> ssh

<span class="kw">conoharant</span> dump
<span class="co"># イメージを保存しておいてマシンを削除する(50GBまではお金がかからない！)</span>
<span class="kw">conoharant</span> restore
<span class="co"># 保存しておいたイメージからマシンを復元する</span></code></pre></div>
</div>
<div id="conoha-gem宣伝" class="slide section level1">
<h1>conoha gem宣伝</h1>
<p>1時間1.3円で使えるのだからネットさえ確保出来ればかなり快適</p>
<p>※私はGMOの回し者ではありません</p>
</div>
<div id="まとめ" class="slide section level1">
<h1>まとめ</h1>
<ul>
<li>
tokushima.rbやってます他にも色々話したいことあります皆来てね
</li>
<li>
Itamae便利だけどシェルスクリプトも分からないとやっぱりダメ
</li>
<li>
conohaってgem作っててこれのお陰で貧弱PCでも開発出来ます良かったらGitHubでStar下さい
</li>
</ul>
</div>
<div id="おしまい" class="slide section level1">
<h1>おしまい</h1>
</div>
</body>
</html>
<!-- Pandoc version:
pandoc 1.17.1
Compiled with texmath 0.8.6.3, highlighting-kate 0.6.2.
Syntax highlighting is supported for the following languages:
    abc, actionscript, ada, agda, apache, asn1, asp, awk, bash, bibtex, boo, c,
    changelog, clojure, cmake, coffee, coldfusion, commonlisp, cpp, cs, css,
    curry, d, diff, djangotemplate, dockerfile, dot, doxygen, doxygenlua, dtd,
    eiffel, elixir, email, erlang, fasm, fortran, fsharp, gcc, glsl,
    gnuassembler, go, hamlet, haskell, haxe, html, idris, ini, isocpp, java,
    javadoc, javascript, json, jsp, julia, kotlin, latex, lex, lilypond,
    literatecurry, literatehaskell, llvm, lua, m4, makefile, mandoc, markdown,
    mathematica, matlab, maxima, mediawiki, metafont, mips, modelines, modula2,
    modula3, monobasic, nasm, noweb, objectivec, objectivecpp, ocaml, octave,
    opencl, pascal, perl, php, pike, postscript, prolog, pure, python, r,
    relaxng, relaxngcompact, rest, rhtml, roff, ruby, rust, scala, scheme, sci,
    sed, sgml, sql, sqlmysql, sqlpostgresql, tcl, tcsh, texinfo, verilog, vhdl,
    xml, xorg, xslt, xul, yacc, yaml, zsh
Default user data directory: <DELETED>
Copyright (C) 2006-2016 John MacFarlane
Web:  http://pandoc.org
This is free software; see the source for copying conditions.
There is no warranty, not even for merchantability or fitness
for a particular purpose.
-->
